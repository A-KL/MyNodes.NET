<br />

<div class="panel panel-default">
    <div class="panel-heading">
        Gateway Messages
        <button type="button" class="btn btn-default pull-right" id="clear-log">
            <span class="glyphicon glyphicon-erase" aria-hidden="true"></span>
            Clear Messages
        </button><br><br>


    </div>
    <div class="panel-body" style="overflow-y: scroll;" id="log">
    </div>

</div>


@section scripts
        {

    <script>
        $(function () {
            //configure signalr
            var clientsHub = $.connection.clientsHub;

            clientsHub.client.OnMessageRecievedEvent = function (message) {
                $('#log').append(message + "<br/>");
                $('#log').animate({ scrollTop: $('#log').get(0).scrollHeight }, 0);
            };

            clientsHub.client.OnConnectedEvent = function () {
                hardwareStateChanged(true);
            };

            clientsHub.client.OnDisconnectedEvent = function () {
                hardwareStateChanged(false);
            };

            $.connection.hub.start();


            //clear messages button
            $('#clear-log').on('click', function () {
                $('#log').html("");
                $.ajax({ url: "/Gateway/ClearMessages/" });
            });

            getIsHardwareConnected();
            getMessages();



            //autoscroll
            $(function () {
                var window_height = $(window).height(),
                    content_height = window_height - 280;
                $('#log').height(content_height);
            });

            $(window).resize(function () {
                var window_height = $(window).height(),
                    content_height = window_height - 280;
                $('#log').height(content_height);
            });
        });


        var gatewayHardwareConnected = true;

        function getIsHardwareConnected() {
            $.ajax({
                url: "/Gateway/IsHardwareConnected/",
                type: "POST",
                success: function (connected) {
                    hardwareStateChanged(connected);
                }
            });
        }

        function hardwareStateChanged(connected) {
            if (connected && !gatewayHardwareConnected) {
                var n = noty({ text: 'Gateway hardware is online.', type: 'alert', timeout: false });
                $('#log').append("Gateway hardware is online." + "<br/>");
                $('#log').animate({ scrollTop: $('#log').get(0).scrollHeight }, 0);
            } else if (!connected && gatewayHardwareConnected) {
                var n = noty({ text: 'Gateway hardware is offline!', type: 'error', timeout: false });
                $('#log').append("Gateway hardware is offline!" + "<br/>");
                $('#log').animate({ scrollTop: $('#log').get(0).scrollHeight }, 0);
            }

            gatewayHardwareConnected = connected;
        }

        function getMessages() {
            $.ajax({
                url: "/Gateway/GetMessages/",
                type: "POST",
                success: function (messages) {
                    onReturnMessages(messages);
                }
            });
        }

        function onReturnMessages(messages) {
            $('#log').html(messages);
            $('#log').animate({ scrollTop: $('#log').get(0).scrollHeight }, 0);
        };



    </script>
}


